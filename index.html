<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Alarm Condition Game</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #container { display: flex; padding: 20px; box-sizing: border-box; align-items: flex-start; }
    #main { flex: 3; padding: 20px; }
    #sidebar { flex: 1; border-left: 1px solid #ccc; padding: 20px; overflow-y: auto; }
    .condition { margin-bottom: 20px; padding: 10px; border: 1px solid #aaa; border-radius: 6px; background: #f9f9f9; }
    .condition.active { background-color: #d0ebff; }
    .action-btn { display: block; margin: 8px 0; padding: 10px; width: 100%; cursor: pointer; background-color: #f2f2f2; border: 1px solid #999; border-radius: 5px; }
    .action-btn:hover { background-color: #e0ffe0; }
    #timer { font-size: 1.5em; margin-bottom: 10px; font-weight: bold; color: #0077cc; }
    #fatigueMeter { font-size: 1.2em; margin-bottom: 20px; color: #cc0000; }
    #goBtn { font-size: 1.5em; padding: 10px 20px; cursor: pointer; }
    #finalScore { font-size: 1.3em; color: green; font-weight: bold; margin-top: 10px; }
    #playAgainBtn { display: none; margin-top: 20px; padding: 10px 20px; font-size: 1em; }
    #completeBtn { display: none !important; } /* hidden, not used */
    #mcPanel { padding: 20px; border-top: 1px solid #e5e5e5; margin: 24px 20px; position: relative; }
    .mc-grid { display: grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap: 12px; }
    .mc-card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; background: #fafafa; }
    .mc-title { font-weight: bold; margin-bottom: 8px; }
    .mc-actions { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { padding: 8px 12px; border: 1px solid #999; border-radius: 8px; background: #f5f5f5; cursor: pointer; }
    .btn:hover { background: #e8f3ff; }
    .mc-summaries { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 16px; }
    .summary { border: 1px solid #ddd; border-radius: 10px; padding: 12px; background: #fff; }
    .summary h4 { margin: 0 0 8px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #eee; padding: 6px 8px; text-align: left; font-size: 0.95em; }
    th { background: #f7f7f7; }
    @media(max-width: 900px) { .mc-grid { grid-template-columns: repeat(2, 1fr); } .mc-summaries { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<!-- Start screen -->
<div id="startScreen" style="text-align:center; padding: 100px;">
  <select id="modeSelector">
    <option value="simple">Simple Display</option>
    <option value="severity">Severity Order</option>
    <option value="simpleHide">Simple Display (Hide on Resolve)</option>
    <option value="severityHide">Severity Order (Hide on Resolve)</option>
  </select>
  <br><br>
  <button id="goBtn">GO</button>
</div>

<!-- Game container -->
<div id="container" style="display:none;">
  <div id="main">
    <div id="timer">‚è±Ô∏è 00:00:00</div>
    <div id="fatigueMeter">Fatigue: 0.00</div>
    <div id="finalScore"></div>
    <button id="playAgainBtn">üîÅ Play Again</button>
    <div id="conditions"></div>
  </div>
  <div id="sidebar">
    <h3>Actions</h3>
    <!-- Kept but hidden -->
    <button id="completeBtn" class="action-btn">‚úÖ Complete</button>
  </div>
</div>

<!-- Monte Carlo Simulation Panel -->
<div id="mcPanel">
  <h3>Monte Carlo: Alarm Presentation Policies</h3>
  <div class="mc-grid">
    <div class="mc-card">
      <div class="mc-title">Simulation</div>
      <label>N trials<br><input id="mcN" type="number" min="10" step="10" value="200"></label><br><br>
      <label># Conditions<br><input id="mcConds" type="number" min="1" max="20" value="6"></label><br><br>
      <label>Arrival Horizon (s)<br><input id="mcHorizon" type="number" min="0" max="60" value="10"></label><br><br>
      <label>T (fatigue const, s)<br><input id="mcT" type="number" min="30" max="1000" value="240"></label>
    </div>
    <div class="mc-card">
      <div class="mc-title">Human (Operator)</div>
      <label>Base Task (s)<br><input id="hBase" type="number" min="0.5" step="0.5" value="2.5"></label><br><br>
      <label>Jitter (s)<br><input id="hJitter" type="number" min="0" step="0.5" value="2"></label><br><br>
      <label>Task Strategy<br>
        <select id="hTaskStrategy">
          <option value="highestSeverity">Highest Severity</option>
          <option value="earliestShown">Earliest Shown</option>
          <option value="preemptOnHigherSeverity">Preempt on Higher Severity</option>
        </select>
      </label>
      <br><br>
      <label>Preempt Threshold (0‚Äì1)<br><input id="hPreempt" type="number" min="0" max="1" step="0.05" value="0.8"></label>
    </div>
    <div class="mc-card">
      <div class="mc-title">Policy 1</div>
      <select id="s1">
        <option value="singleHighest">Single-queued (don‚Äôt switch)</option>
        <option value="singleHighestNonInterrupting">Single-queued (alias)</option>
        <option value="severityEscalation">Severity Escalation (interrupt)</option>
        <option value="showAll">All at once</option>
      </select>
    </div>
    <div class="mc-card">
      <div class="mc-title">Policy 2</div>
      <select id="s2">
        <option value="showAll">All at once</option>
        <option value="singleHighest">Single-queued (don‚Äôt switch)</option>
        <option value="singleHighestNonInterrupting">Single-queued (alias)</option>
        <option value="severityEscalation">Severity Escalation (interrupt)</option>
      </select>
      <div class="mc-actions">
        <button id="runMc" class="btn">‚ñ∂ Run Simulation</button>
        <button id="dlCsv" class="btn" disabled>‚¨á Download CSV</button>
      </div>
      <div id="mcStatus" style="margin-top:8px;color:#0077cc;"></div>
    </div>
  </div>
  <div class="mc-summaries">
    <div class="summary"><h4>Policy 1 Summary</h4><div id="sumATable"></div></div>
    <div class="summary"><h4>Policy 2 Summary</h4><div id="sumBTable"></div></div>
  </div>
</div>

<audio id="lowSound" src="./assets/low.mp3"></audio>
<audio id="mediumSound" src="./assets/medium1.mp3"></audio>
<audio id="highSound" src="./assets/hhh.mp3"></audio>

<script src="./js/alarm_concepts.js"></script>
<script>
  let trial, startTime, interval, correctActions=[], score=0, activeConditionIndex=-1, displayCounter=1, hideResolved=false;

  const goBtn=document.getElementById("goBtn"), playAgainBtn=document.getElementById("playAgainBtn"), startScreen=document.getElementById("startScreen"),
        container=document.getElementById("container"), conditionsDiv=document.getElementById("conditions"), timerDisplay=document.getElementById("timer"),
        finalScoreDiv=document.getElementById("finalScore"), sidebar=document.getElementById("sidebar"), fatigueMeter=document.getElementById("fatigueMeter");
  const completeBtn=document.getElementById("completeBtn"); // hidden but harmless

  const low=document.getElementById("lowSound"), medium=document.getElementById("mediumSound"), high=document.getElementById("highSound");
  function stopAllAlarms(){[low,medium,high].forEach(a=>{a.pause();a.currentTime=0;a.loop=false;});}
  function updateAlarmSound(){ if(!trial) return; const active=trial.conditions.filter(c=>c.shown&&!c.resolved); if(active.length===0){stopAllAlarms();return;}
    const maxSeverity=Math.max(...active.map(c=>c.severity)); const target=(maxSeverity<=2)?low:(maxSeverity===3?medium:high);
    [low,medium,high].forEach(a=>{if(a!==target){a.pause();a.currentTime=0;a.loop=false;}}); if(target.paused){target.loop=true; target.play().catch(()=>{});} }

  function formatTime(ms){const s=Math.floor(ms/1000); return [String(Math.floor(s/3600)).padStart(2,'0'),String(Math.floor(s/60)%60).padStart(2,'0'),String(s%60).padStart(2,'0')].join(":");}
  function updateTimer(){const now=Date.now(); timerDisplay.innerHTML=`‚è±Ô∏è ${formatTime(now-startTime)}`; const sec=Math.floor((now-startTime)/1000);
    trial.getConditionsToShow(sec).forEach(c=>{showCondition(c,trial.conditions.indexOf(c)); c.shown=true; c.startShownTime=Date.now();});
    highlightCurrent(); trial.calculateFatigue(now,1); fatigueMeter.textContent=`Fatigue: ${trial.fatigue.toFixed(2)}`; updateAlarmSound();}

  function showCondition(c,i){c.displayNumber=displayCounter++; const div=document.createElement("div"); div.className="condition"; div.id=`condition-${i}`;
    div.innerHTML=`<strong>Condition ${c.displayNumber}</strong><br><em>Severity: ${c.severity}</em><br><span><strong>Correct Action:</strong> ${correctActions[i]}</span><br><span id="selected-${i}">Selected: None</span>`;
    conditionsDiv.appendChild(div);}
  function highlightCurrent(){document.querySelectorAll(".condition").forEach(div=>div.classList.remove("active")); for(const div of document.querySelectorAll(".condition")){const i=parseInt(div.id.split("-")[1]); const c=trial.conditions[i];
      if(c.shown&&!c.resolved){div.classList.add("active"); activeConditionIndex=i; return;}} activeConditionIndex=-1;}

  function handleActionClick(action){ if(activeConditionIndex===-1) return; const c=trial.conditions[activeConditionIndex]; const correct=correctActions[activeConditionIndex];
    if(action!==correct){alert("‚ùå Wrong action! -2 points"); score-=2; return;}
    document.getElementById(`selected-${activeConditionIndex}`).textContent=`Selected: ${action} ‚úÖ`; c.resolve();
    const gain=(c.severity**3)/Math.max(1e-6,c.getResolutionTimeInSeconds()); score+=trial.adjustPerformance(gain);
    if(hideResolved){document.getElementById(`condition-${activeConditionIndex}`)?.remove();} highlightCurrent(); updateAlarmSound();
    if(trial.allResolved()){clearInterval(interval); stopAllAlarms(); finalScoreDiv.textContent=`üéØ Trial Complete! Final Score: ${score.toFixed(2)} | Accuracy‚âà${(trial.accuracy()*100).toFixed(0)}% | Speed√ó${trial.speedFactor().toFixed(2)}`;
      playAgainBtn.style.display="inline-block";} }

  function generateActionButtons(n){ sidebar.innerHTML="<h3>Actions</h3>"; sidebar.appendChild(completeBtn);
    for(let i=1;i<=10;i++){const b=document.createElement("button"); b.className="action-btn"; b.textContent=`Action ${i}`; b.dataset.action=`Action ${i}`;
      b.addEventListener("click",()=>handleActionClick(b.dataset.action)); sidebar.appendChild(b);}
    const all=Array.from({length:10},(_,i)=>`Action ${i+1}`); correctActions=all.sort(()=>0.5-Math.random()).slice(0,n); }

  function startTrial(mode){ if(interval) clearInterval(interval); stopAllAlarms();
    trial=new Trial(mode,6); score=0; startTime=Date.now(); displayCounter=1; trial.resetFatigue();
    conditionsDiv.innerHTML=""; finalScoreDiv.textContent=""; playAgainBtn.style.display="none"; fatigueMeter.textContent=`Fatigue: ${trial.fatigue.toFixed(2)}`;
    generateActionButtons(trial.conditions.length);
    if(mode==="severity"||mode==="severityHide"){trial.conditions.sort((a,b)=>b.severity-a.severity); hideResolved=(mode==="severityHide");
      trial.conditions.forEach((c,i)=>{showCondition(c,i); c.shown=true; c.startShownTime=Date.now();}); highlightCurrent(); interval=setInterval(updateTimer,1000); updateAlarmSound();}
    else{hideResolved=(mode==="simpleHide"); interval=setInterval(updateTimer,1000);} }

  goBtn.addEventListener("click",()=>{startScreen.style.display="none"; container.style.display="flex"; startTrial(document.getElementById("modeSelector").value);});
  playAgainBtn.addEventListener("click",()=>{container.style.display="none"; startScreen.style.display="block"; playAgainBtn.style.display="none";});


  /* ====== Monte Carlo UI (Policies) ====== */
  const mcEls = {
    N: document.getElementById('mcN'),
    conds: document.getElementById('mcConds'),
    horizon: document.getElementById('mcHorizon'),
    T: document.getElementById('mcT'),
    hBase: document.getElementById('hBase'),
    hJitter: document.getElementById('hJitter'),
    hTaskStrategy: document.getElementById('hTaskStrategy'),
    s1: document.getElementById('s1'),
    s2: document.getElementById('s2'),
    run: document.getElementById('runMc'),
    dl: document.getElementById('dlCsv'),
    status: document.getElementById('mcStatus'),
    sumATable: document.getElementById('sumATable'),
    sumBTable: document.getElementById('sumBTable')
  };

  function renderSummary(el, summary) {
    el.innerHTML = `
      <table>
        <tr><th>Trials</th><td>${summary.count}</td></tr>
        <tr><th>Mean Time (s)</th><td>${summary.meanTime.toFixed(1)}</td></tr>
        <tr><th>P50 Time (s)</th><td>${summary.p50Time.toFixed(1)}</td></tr>
        <tr><th>P90 Time (s)</th><td>${summary.p90Time.toFixed(1)}</td></tr>
        <tr><th>Mean Fatigue</th><td>${summary.meanFatigue.toFixed(3)}</td></tr>
        <tr><th>P50 Fatigue</th><td>${summary.p50Fatigue.toFixed(3)}</td></tr>
        <tr><th>P90 Fatigue</th><td>${summary.p90Fatigue.toFixed(3)}</td></tr>
        <tr><th>Mean Accuracy</th><td>${(summary.meanAccuracy*100).toFixed(1)}%</td></tr>
        <tr><th>P50 Accuracy</th><td>${(summary.p50Acc*100).toFixed(1)}%</td></tr>
        <tr><th>P90 Accuracy</th><td>${(summary.p90Acc*100).toFixed(1)}%</td></tr>
        <tr><th>Mean Harm</th><td>${summary.meanHarm.toFixed(1)}</td></tr>
        <tr><th>P50 Harm</th><td>${summary.p50Harm.toFixed(1)}</td></tr>
        <tr><th>P90 Harm</th><td>${summary.p90Harm.toFixed(1)}</td></tr>
      </table>
    `;
  }

  function toCSV(label, samples) {
    const rows = [["policy","totalTimeSec","finalFatigue","avgAccuracy","avgSpeedFactor","resolved","totalHarm"]];
    for (const r of samples) {
      rows.push([label, r.totalTimeSec, r.finalFatigue, r.avgAccuracy, r.avgSpeedFactor, r.resolved, r.totalHarm]);
    }
    return rows.map(r => r.join(",")).join("\n");
  }

  mcEls.run.addEventListener('click', () => {
    mcEls.status.textContent = "Running‚Ä¶";
    mcEls.dl.disabled = true;

    const N = parseInt(mcEls.N.value, 10);
    const number_conditions = parseInt(mcEls.conds.value, 10);
    const horizonArrivalSec = parseInt(mcEls.horizon.value, 10);
    const Tconst = parseInt(mcEls.T.value, 10);

    const operator = new UserProfile({
      name: "op",
      baseTaskTimeSec: parseFloat(mcEls.hBase.value),
      taskTimeJitterSec: parseFloat(mcEls.hJitter.value),
      taskStrategy: mcEls.hTaskStrategy.value
    });

    const out = runMonteCarloPolicies({
      N,
      operator,
      trialParams: { number_conditions, horizonArrivalSec, T_for_notes: Tconst },
      policies: [mcEls.s1.value, mcEls.s2.value]
    });

    const s1Summary = out[mcEls.s1.value].summary;
    const s2Summary = out[mcEls.s2.value].summary;

    renderSummary(mcEls.sumATable, s1Summary);
    renderSummary(mcEls.sumBTable, s2Summary);

    const csv = toCSV("policy1", s1Summary.samples) + "\n" + toCSV("policy2", s2Summary.samples);
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    mcEls.dl.disabled = false;
    mcEls.dl.onclick = () => {
      const a = document.createElement('a');
      a.href = url;
      a.download = `monte_carlo_policies_${N}trials.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };

    mcEls.status.textContent = "Done.";
  });
</script>

</body>
</html>
